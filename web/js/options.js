var loggedInUser,CLIENT_ID="453486582246-qr4dr1lbclp9149pead96tbtetuvcduj.apps.googleusercontent.com",API_KEY="AIzaSyBPUJKB5QecgWwtdU4CmX9SrDnXpf0V3w8",daysDiff=7776e6,DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest","https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest","https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],SCOPES="https://www.googleapis.com/auth/drive profile email https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/tasks",messagesList=[],authorizeButton=document.getElementById("authorize_button"),signoutButton=document.getElementById("signout_button"),signoutButtonHtml='<button id="signout_button" class="btn btn-sm btn-danger" style="margin-left:10px;">Sign Out</button>',firstTimeLoad=!0,tzoffset=6e4*(new Date).getTimezoneOffset();function handleClientLoad(){gapi.load("client:auth2",initClient)}function initClient(){gapi.client.init({apiKey:API_KEY,clientId:CLIENT_ID,discoveryDocs:DISCOVERY_DOCS,scope:SCOPES}).then(function(){gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus),updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get()),authorizeButton.onclick=handleAuthClick})}function createTaskOrEvent(){var e=$("#icon-active-modal-submit-btn").attr("data-icon"),t=$("#icon-active-modal-submit-btn").attr("data-text"),a=$("#icon-active-modal-submit-btn").attr("data-fileName");if("Task"==e||"Event"==e||"Reminder"==e){var i,n=$("#datetimepicker input").val(),o=$("#taskDate input").val();if("Task"==e){if("Invalid Date"==new Date(o))return $("#taskDate input").css({borderColor:"red"}),!1}else if("Invalid Date"==new Date(n))return $("#datetimepicker input").css({borderColor:"red"}),!1;if($("#datetimepicker input").css({borderColor:"none"}),"Task"==e)i=gapi.client.tasks.tasks.insert({tasklist:"@default",title:a,notes:t,due:new Date(new Date(o).getTime()+tzoffset).toISOString()});else if("Reminder"==e||"Event"==e){var s={summary:a,description:t,start:{dateTime:new Date(n).toISOString()},end:{dateTime:new Date(n).toISOString()}};"Reminder"==e&&(s.reminders={useDefault:!1,overrides:[{method:"email",minutes:0},{method:"popup",minutes:0},{method:"sms",minutes:0}]}),i=gapi.client.calendar.events.insert({calendarId:"primary",resource:s})}i.execute(function(t){if(t.id){var a=getMessageIndex($("#icon-active-modal-submit-btn").attr("data-commentId")),i=messagesList[a];if("Task"==e)n=formateDateToMMDDYYYY(n=new Date(t.due),!1),i.taskId=t.id,i.taskText='<span style="color: #337ab7;width: 25% !important; display: inline-block;"><b> Task : </b>'+n+"</span>",i.taskDate=n;else if("Reminder"==e){i.reminderId=t.id;var n=new Date(t.start.dateTime);i.reminderText='<span style="color: #337ab7;width: 40% !important; display: inline-block;"><b> Reminder : </b>'+n.toLocaleString()+"</span>",i.reminderDate=n.toLocaleString()}else if("Event"==e){n=new Date(t.start.dateTime);i.eventId=t.id,i.eventText='<span style="color: #337ab7;width: 35% !important; display: inline-block;"><b> Event : </b>'+n.toLocaleString()+"</span>",i.eventDate=n.toLocaleString()}messagesList[a]=i,updateMessageOrder(messagesList),setTimeout(function(){listFiles()},1e3)}setTimeout(function(){$("#icon-active-modal").modal("hide")},2e3)})}else $("#icon-active-modal").modal("hide");return!1}function updateSigninStatus(e){e?(loggedInUser="+"+gapi.auth2.getAuthInstance().currentUser.Ab.w3.U3,$(authorizeButton).addClass("hidden"),$(".table-inbox").removeClass("hidden"),makeTableSortable(),setTimeout(function(){listFiles()},1e3)):($(authorizeButton).removeClass("hidden"),$(".table-inbox").addClass("hidden"),$(".dataTables_filter").remove())}function handleAuthClick(e){gapi.auth2.getAuthInstance().signIn({scope:"profile email"}).then(function(e){try{loggedInUser="+"+e.w3.U3}catch(e){console.log("error",e)}})}function handleSignoutClick(e){gapi.auth2.getAuthInstance().signOut()}function appendPre(e,t){var a=e.mimeType,i="";i=a.indexOf("application/vnd.google-apps")>-1?"https://docs.google.com/"+(a=a.replace("application/vnd.google-apps.",""))+"/d/"+e.id+"/edit":"https://drive.google.com/file/d/"+e.id+"/edit";var n=getMessageIndex(t.id),o=messagesList[n]||{},s=(o.eventText||"")+(o.reminderText||"")+(o.keepText||"")+(o.taskText||""),l=o.eventId||"",d=o.reminderId||"",r=o.keepId||"",c=o.taskId||"",m=""==$.trim(l)?"":" active ",u=""==$.trim(d)?"":" active ",g=""==$.trim(r)?"":" active ",p=""==$.trim(c)?"":" active ",f=o.taskDate||"",v=o.reminderDate||"",h=o.eventDate||"",b='<tr id="row-'+t.id+'">\t\t\t<td>'+n+'</td>\t\t\t<td><a target="_blank" href="'+i+'">'+e.name+"</a></td>\t\t\t<td>"+new Date(t.createdTime).toLocaleString()+'</td>\t\t\t<td>\t\t\t<span class="commentText" >'+t.content+"</span><br/>"+s+'\t\t\t</td>\t\t\t<td>\t\t\t<i class="icons fa fa-edit taskIcon googleIcons '+p+'" title="Google Task" data-icon="Task" data-id="'+c+'" data-task-date="'+f+'"></i>\t\t\t<i class="icons fa fa-lightbulb keepIcon googleIcons '+g+'" title="Google Keep" data-icon="Notes" data-id="'+r+'" style="display:none;"></i>\t\t\t<i class="icons fa fa-thumbtack reminderIcon googleIcons '+u+'" title="Google Reminder" data-icon="Reminder" data-id="'+d+'" data-reminder-date="'+v+'"></i>\t\t\t<i class="icons fa fa-calendar-alt calendarIcon googleIcons '+m+'" title="Google Calendar" data-icon="Event" data-id="'+l+'" data-event-date="'+h+'"></i>\t\t\t<i class="icons fa fa-reply" data-dismiss="modal" data-toggle="modal" data-target="#reply-modal" \t\t\t\t\tid="'+t.id+'" onclick="fillInReply(\''+e.name+"','"+escape(t.content)+"',this.id,'"+e.id+'\')">\t\t\t</i>\t\t\t<i id="delete-'+t.id+'"  class="icons fa fa-trash" onclick="showDeleteOrMarkAsResolvePopup(\''+t.id+"','"+e.id+'\',\'delete\')" tooltip="Delete Comment"></i>\t\t\t<i id="resolve-'+t.id+'" class="icons fa fa-check" onclick="showDeleteOrMarkAsResolvePopup(\''+t.id+"','"+e.id+"','markAsResolved')\" tooltip=\"Mark As Resolved\"></i>\t\t\t</td>\t\t\t</tr>",k=$(".table-inbox").DataTable(),T=!0;try{T=new Date(t.createdTime)>=new Date($("#date").val())}catch(e){console.log(e)}0==$("#"+t.id).length&&T&&k.row.add($(b)).draw()}function showDeleteOrMarkAsResolvePopup(e,t,a){if("delete"==a?($(".deleteComment").removeClass("hidden"),$(".markAsResolved").addClass("hidden")):"markAsResolved"==a&&($(".deleteComment").addClass("hidden"),$(".markAsResolved").removeClass("hidden")),"delete"==a||"markAsResolved"==a){var i=$("#row-"+e).find(".commentText").text();$(".commentContent").html(i);var n=$("#deleteOrMarkAsResolved-button");n.attr("actionType",a),n.attr("commentId",e),n.attr("fileId",t),$("#delete-modal").modal("show")}}function deleteOrMarkAsResolved(){var e=$("#deleteOrMarkAsResolved-button"),t=e.attr("actionType"),a=e.attr("commentId"),i=e.attr("fileId");switch(t){case"delete":deleteComment(a,i),$("#delete-modal").modal("hide");break;case"markAsResolved":markAsResolved(a,i),$("#delete-modal").modal("hide");break;default:$("#delete-modal").modal("hide")}return!1}function deleteComment(e,t){gapi.client.drive.comments.delete({fileId:t,commentId:e}).execute(function(e){console.log(e),e.result&&($("#delete-modal").modal("hide"),listFiles())})}function markAsResolved(e,t){gapi.client.drive.replies.create({fileId:t,commentId:e,fields:"content",action:"resolve",content:"resolved"}).execute(function(t){console.log(t),"resolved"===t.content&&$("#resolve-"+e+",#"+e).attr("disabled","disabled")})}function sendReply(){return $("#reply-button").addClass("disabled"),sendMessage($("#reply-message-id").attr("fileId"),$("#reply-message-id").val(),$("#reply-message").val(),replyTidy),!1}function replyTidy(e){console.log("reply response "+e),$("#reply-modal").modal("hide"),$("#reply-message").val(""),$("#reply-button").removeClass("disabled")}function fillInReply(e,t,a,i){$("#reply-to").val(e),$("#reply-subject").val(unescape(t)),$("#reply-message-id").val(a),$("#reply-message-id").attr("fileId",i)}function sendMessage(e,t,a,i){return gapi.client.drive.replies.create({fileId:e,commentId:t,fields:"content",content:a}).execute(i)}function listFiles(){var e=$("#date").val();if("Invalid Date"!=new Date(e)){try{$(".table-inbox").DataTable().clear().draw()}catch(e){console.log(e)}var t=loadAllFiles;$("#date").css({borderColor:""});var a=new Date(e).toISOString().split(".")[0],i=function(e,n){e.execute(function(o){o.files=o.files||[],n=n.concat(o.files);var s=o.nextPageToken;s?(e=gapi.client.drive.files.list({q:"modifiedTime > '"+a+"'",pageSize:1e3,pageToken:s,userIp:"ActionItemsManager",fields:"nextPageToken, files(id, name, mimeType)"}),i(e,n)):t(n)})},n=gapi.client.drive.files.list({q:"modifiedTime > '"+a+"'",pageSize:1e3,userIp:"ActionItemsManager",fields:"nextPageToken, files(id, name, mimeType)"});i(n,[])}else $("#date").css({borderColor:"red"})}function loadAllFiles(e){if(e&&e.length>0){$(".overlay").show();for(var t=0;t<e.length;t++)!function(a){setTimeout(function(){listAllComments(e[a]),a+1==e.length&&$(".overlay").hide()},200*t)}(t)}}function listAllComments(e){var t,a,i=e.id,n=loadAllComments,o=$("#date").val(),s=new Date(o).toISOString(),l=gapi.client.drive.comments.list({fileId:i,pageSize:100,userIp:"ActionItemsManager",fields:"nextPageToken, comments(id,content,htmlContent,resolved,createdTime)"});a=[],(t=l).execute(function(o){o.comments=o.comments||[],a=a.concat(o.comments);var l=o.nextPageToken;l?(t=gapi.client.drive.comments.list({fileId:i,pageSize:100,startModifiedTime:s,pageToken:l,userIp:"ActionItemsManager",fields:"nextPageToken, comments(id,content,htmlContent,resolved,createdTime)"}),getPageOfFiles(t,a)):n(e,a)})}function makeTableSortable(){try{$(".table-inbox").DataTable().clear().draw(),$(".table-inbox").DataTable().destroy()}catch(e){console.log(e)}try{$("#datetimepicker").datetimepicker()}catch(e){console.log(e)}var e=$(".table-inbox").DataTable({paging:!1,rowReorder:!0,iDisplayLength:"All",order:[[0,"asc"]],bInfo:!1,columnDefs:[{targets:0,visible:!1},{orderable:!0,className:"reorder",targets:1},{orderable:!0,className:"reorder",targets:2},{orderable:!1,targets:"_all"}],fnInitComplete:function(e){var t=new Date;t=formateDateToHTML5Date(t);var a=new Date,i=formateDateToHTML5Date(a=new Date(a-daysDiff)),n='<label style="width: 250px;">        \t\tSearch from : \t\t\t\t<input type="date" placeholder="mm/dd/yyyy" id="date" max="'+t+'" onkeydown="return false;" value="'+i+'">\t\t\t</label>';0==$("#date").length&&($(".dataTables_filter").append('<button id="refreshItem" onclick="listFiles();" class="btn btn-primary btn-sm" style="margin-left: 7px;">Refresh</button>'),$(".dataTable thead tr th:last").append(n),$(signoutButtonHtml).appendTo($(".dataTables_filter")),setTimeout(function(){(signoutButton=document.getElementById("signout_button")).onclick=handleSignoutClick},1e3),$("#date").change(listFiles)),firstTimeLoad&&(firstTimeLoad=!1,$("#date").val(i))}});e.on("row-reorder",function(e,t,a){var i=[];$(".table-inbox tbody tr").each(function(){var e=$(this).attr("id"),t={id:e=e.replace(/row-/gi,"")};i.push(t)}),updateMessageOrder(i)}),$(".table-inbox thead tr").off("click","th"),$(".table-inbox thead tr").on("click","th",function(){var t=e.column(this).index();if(1==t||2==t){var a=[];$(".table-inbox tbody tr").each(function(){var e=$(this).attr("id"),t={id:e=e.replace(/row-/gi,"")};a.push(t)}),updateMessageOrder(a)}})}function updateMessageOrder(e){messagesList=e}function getMessageIndex(e){for(var t=-1,a=0;a<messagesList.length;a++)if(e==messagesList[a].id){t=a;break}return t>-1?t:999999999999}function formateDateToHTML5Date(e){var t=e.getFullYear(),a=e.getMonth()+1;a<10&&(a="0"+a);var i=e.getDate();return i<10&&(i="0"+i),t+"-"+a+"-"+i}function formateDateToMMDDYYYY(e,t){var a=e.getFullYear(),i=e.getMonth()+1;i<10&&t&&(i="0"+i);var n=e.getDate();return n<10&&t&&(n="0"+n),i+"/"+n+"/"+a}function formatDate(e){var t="";try{t=e.replace("T"," ").split(".")[0]}catch(e){t=""}return t}function loadAllComments(e,t){if(t&&t.length>0){console.log(t);for(var a=0;a<t.length;a++){var i=t[a],n=i.content;!i.resolved&&n.indexOf(loggedInUser)>-1&&(i.content=n,appendPre(e,i))}}}function sleep(e){for(var t=(new Date).getTime(),a=0;a<1e7&&!((new Date).getTime()-t>e);a++);}$(document).on("click",".googleIcons",function(){var e=$(this).hasClass("active"),t=$(this).attr("data-icon"),a=$(this).attr("title");$("#icon-active-modal .modal-title").text(a);var i=$(this).attr("data-icon"),n=$(this).closest("tr").attr("id");n=n.replace("row-","");var o=$("#row-"+n).find(".commentText").text();$(".commentContent").html(i+" : "+o);var s=$("#row-"+n).find("td:first a").text();$("#datetimepicker input, #taskDate input").css({borderColor:"none"});var l=$(this).attr("data-"+t+"-date")||"";if($("#datePickerSelectionDiv").show(),"Task"==t?(l=formateDateToHTML5Date(l=new Date(l)),$("#datetimepicker").hide(),$("#taskDate").show(),$("#taskDate input").val(l)):($("#datetimepicker input").val(l),$("#datetimepicker").show(),$("#taskDate").hide()),e){$(this).attr("data-id");$("#icon-active-modal-submit-btn").hide()}else if($("#icon-active-modal-submit-btn").show(),$("#icon-active-modal-submit-btn").attr("data-icon",t),$("#icon-active-modal-submit-btn").attr("data-text",o),$("#icon-active-modal-submit-btn").attr("data-fileName",s),$("#icon-active-modal-submit-btn").attr("data-commentId",n),$("#datetimepicker > span").click(),setTimeout(function(){$("#datetimepicker > span").click()},1),"Task"!=t&&"Event"!=t&&"Reminder"!=t||$("#icon-active-modal-submit-btn").text("Create "+t),0==messagesList.length){var d=[];$(".table-inbox tbody tr").each(function(){var e=$(this).attr("id"),t={id:e=e.replace(/row-/gi,"")};d.push(t)}),updateMessageOrder(d)}$("#icon-active-modal").modal("show")});